
**How to Convert YOLOv3 to Caffe**

1. First copy the [this python script](https://github.com/aminmamandi/Xilinx_Vitis_AI/blob/main/Darknet_to_Caffe/convert.py) to docker container workspace.
2. Use the following command to make the conversion:
> First activate the caffe environment inside the Vitis AI docker container (conda activate vitis-ai-caffe)
```
python convert.py darknet/yolov3.cfg darknet/yolov3.weights yolov3.prototxt yolov3.caffemodel
```
3. In order to Quantize the caffe model, we need to make some minor changes to the .PROTOTXT file. 
> Commenting out the first five line and adding an ImageData layer with the calibration images for the train phase as shown in the following fragment:

```
name: "Darknet2Caffe"
#####Comment following five lines generated by converter#####
#input: "data"
#input_dim: 1
#input_dim: 3
#input_dim: 608
#input_dim: 608
#####Change input data layer to ImageDate and modify root_folder/source before run DECENT#####
layer {
name: "data"
type: "ImageData"
top: "data"
top: "label"
include {
  phase: TRAIN
}
transform_param {
  mirror: false
  yolo_height:608    #change height according to Darknet model
  yolo_width:608     #change width  according to Darknet model
}
image_data_param {
  source:"/PATH_TO/5_file_for_test/calib.txt"         #change path accordingly
  root_folder:"/PATH_TO/5_file_for_test/calib_data/"  #change path accordingly
  batch_size: 1
  shuffle: false
}
}
##### No changes after below layers#####


```

The format of calib.txt used in the calibration phase of DNNDK decent is as follows:

```
#image_name                    # fake_label_number
COCO_train2014_000000000009.jpg 1
COCO_train2014_000000000025.jpg 1
COCO_train2014_000000000030.jpg 1
COCO_train2014_000000000034.jpg 1
COCO_train2014_000000000036.jpg 1
```
> Note: The label number is not used in the calibration process.

4. After quantization, modify the deploy.prototxt (generated in the previous step) as follows:

```
layer {
name: "data"
type: "Input"
top: "data"
#####Comment following five lines #####
#transform_param {
# mirror: false
# yolo_height: 608
# yolo_width: 608
# }
#####Nothing change to below layers#####
input_param {
shape {yolov3_deploy.tar.gz
dim: 1
dim: 3
dim: 608
dim: 608
}
}
}

```

5. You may Compile the model NOW!
